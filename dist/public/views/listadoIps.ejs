<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>

    <link rel="icon" href="/img/favicon.ico" type="image/x-icon">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/bootstrapCss/bootstrap.min.css" />
    <link rel="stylesheet" href="/bootStrapIcons/bootstrap-icons.css" />

    <script src="/bootStrapJs/bootstrap.js"></script>

    <style>
        .table-responsive {
            max-height: 600px;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container py-4">
        <h1 class="mb-4 text-center">
            <%= title %>
        </h1>

        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>

                        <th scope="col">Dirección IP</th>
                        <th scope="col">Localización</th>
                        <th scope="col">Observaciones</th>
                        <th scope="col">Editar</th>
                        <th scope="col">Borrar</th>
                    </tr>
                </thead>
                <tbody>
                    <% ips.forEach(function(ip) { %>
                        <tr>

                            <td>
                                <a href="http://<%= ip.ip %>" target="_blank"><%= ip.ip %></a>
                            </td>
                            <td>
                                <%= ip.localizacion %>
                            </td>
                            <td>
                                <%= ip.observaciones %>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                    data-bs-target="#editModal" data-ip="<%= ip.ip %>" data-ip_id="<%= ip.id %>"
                                    data-localizacion="<%= ip.localizacion %>"
                                    data-observaciones="<%= ip.observaciones %>">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                                    data-bs-target="#deleteModal" data-ip="<%= ip.ip %>" data-ip_id="<%= ip.id %>"
                                    data-localizacion="<%= ip.localizacion %>"
                                    data-observaciones="<%= ip.observaciones %>">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        <% }); %>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true"
        style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Borrar Ip</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="deleteForm" action="http://<%= ipSeverPort %>/ips/deleteIp" method="POST">

                    <div class="modal-body">
                        <input type="hidden" class="form-control" id="inputId" name="idIp">

                        <div class="mb-3">
                            <label for="inputIp" class="col-form-label">Ip</label>
                            <input type="text" class="form-control"  placeholder="0.0.0.0" maxlength="15" id="inputIp" name="direccionIp" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="message-text" class="col-form-label">Localización</label>
                            <input type="text" class="form-control" id="message-text" name="localizacionIp" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="Observaciones" class="col-form-label">Observaciones</label>
                            <textarea class="form-control" id="Observaciones" name="observacionesIp"
                                readonly></textarea>
                        </div>
                    </div>

                    <div class="modal-footer justify-content-center">
                        <button type="submit" class="btn btn-danger">Borrar</button>
                        <button type="button" class="btn btn-success" data-bs-dismiss="modal">Cancelar</button>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true"
        style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Edición de Ip</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="http://<%= ipSeverPort %>/ips/updateIp" method="POST">

                    <div class="modal-body">

                        <input type="hidden" class="form-control" id="inputId" name="idIp">

                        <div class="mb-3">
                            <label for="recipient-name" class="col-form-label">Ip</label>
                            <input type="text" class="form-control" id="inputIp" name="direccionIp">
                        </div>
                        <div class="mb-3">
                            <label for="message-text" class="col-form-label">Localización</label>
                            <input type="text" class="form-control" id="message-text" name="localizacionIp">
                        </div>
                        <div class="mb-3">
                            <label for="Observaciones" class="col-form-label">Observaciones</label>
                            <textarea class="form-control" id="Observaciones" name="observacionesIp"></textarea>
                        </div>
                    </div>

                    <div class="modal-footer justify-content-center">
                        <button type="submit" class="btn btn-success">Guardar</button>
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                    </div>

                </form>
            </div>
        </div>
    </div>



</body>
<script>
    const ipPuerto='192.168.1.134:3050';
    const editModal = document.getElementById('editModal');


    editModal.addEventListener('show.bs.modal', event => {
        // Botón que disparó el modal
        const button = event.relatedTarget;

        // Obtener los valores de los atributos data-*
        const id = button.getAttribute('data-ip_id');
        const ip = button.getAttribute('data-ip');
        const localizacion = button.getAttribute('data-localizacion');
        const observaciones = button.getAttribute('data-observaciones');

        // Inputs del modal
        const inputId = editModal.querySelector('#inputId');
        const inputIp = editModal.querySelector('#inputIp');
        const inputLocalizacion = editModal.querySelector('#message-text');
        const inputObservaciones = editModal.querySelector('#Observaciones');

        // Asignar valores
        inputIp.value = ip;
        inputId.value = id;
        inputLocalizacion.value = localizacion;
        inputObservaciones.value = observaciones;
    });

    const deleteModal = document.getElementById('deleteModal');


    deleteModal.addEventListener('show.bs.modal', event => {
        // Botón que disparó el modal
        const button = event.relatedTarget;

        // Obtener los valores de los atributos data-*
        const id = button.getAttribute('data-ip_id');
        const ip = button.getAttribute('data-ip');
        const localizacion = button.getAttribute('data-localizacion');
        const observaciones = button.getAttribute('data-observaciones');

        // Inputs del modal
        const inputId = deleteModal.querySelector('#inputId');
        const inputIp = deleteModal.querySelector('#inputIp');
        const inputLocalizacion = deleteModal.querySelector('#message-text');
        const inputObservaciones = deleteModal.querySelector('#Observaciones');

        // Asignar valores
        inputIp.value = ip;
        inputId.value = id;
        inputLocalizacion.value = localizacion;
        inputObservaciones.value = observaciones;
    });
const deleteForm = document.getElementById('deleteForm');

    if (deleteForm) {
        deleteForm.addEventListener('submit', async function(event) {
            // Evita que el formulario se envíe de la manera tradicional (POST)
            event.preventDefault(); 
            
            // 1. Obtener el ID del campo oculto
            const idRegistro = document.getElementById('inputId').value;
            
            if (!idRegistro) {
                console.error("No se encontró el ID del registro para borrar.");
                return;
            }


            const url = `http://${ipPuerto}/ips/deleteIp/${idRegistro}`;
            
            try {
                const response = await fetch(url, {
                    method: 'DELETE', // <-- ¡Esto es lo que hace la magia!
                    headers: {
                        'Content-Type': 'application/json' 
                    }
                    // No enviamos un cuerpo si el ID va en la URL
                });

                if (response.ok) {
                    window.location.href = '/ips/listaIps'; 
                } else {
                    // Manejo de error si el servidor falla
                    const errorData = await response.json();
                    alert(`Error al borrar: ${errorData.message || 'Error desconocido'}`);
                }

            } catch (error) {
                console.error('Fallo en la conexión:', error);
                alert('Fallo en la conexión con el servidor.');
            }
        });
    }



</script>

</html>