<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>

    <link rel="icon" href="/img/favicon.ico" type="image/x-icon">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/bootstrapCss/bootstrap.min.css" />
    <link rel="stylesheet" href="/bootStrapIcons/bootstrap-icons.css" />


    <script src="/bootStrapJs/bootstrap.js"></script>

    <style>
        .table-responsive {
            max-height: 600px;
        }

        .table-responsive thead th {
            position: sticky;
            top: 0;
            /* pega el thead en la parte superior del contenedor */
            z-index: 10;
            /* para que quede sobre las filas */
            background-color: #343a40;
            /* coincide con .table-dark de Bootstrap */
            color: white;
            /* texto legible */
        }

        /* Opcional: resaltar texto filtrado (simple) */
        .highlight {
            background-color: rgba(255, 235, 59, 0.3);
        }
    </style>
</head>

<body class="bg-light">
    <div class="container py-4">
        <h1 class="mb-4 text-center">
            <%= title %>
        </h1>
        <div class="mb-3">
            <input id="buscador" type="text" class="form-control" placeholder="Buscar en la tabla...">

        </div>

    </div>
    <div class="container py-4">
        <div class="table-responsive">
            <table id="tabla-impresoras" class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th style="cursor:pointer">IP</th>
                        <th style="cursor:pointer">Modelo</th>
                        <th style="cursor:pointer">Nº Serie</th>
                        <th style="cursor:pointer">Localización</th>
                        <th style="cursor:pointer">Conectada</th>
                        <th style="cursor:pointer">Negro</th>
                        <th style="cursor:pointer">Cyan</th>
                        <th style="cursor:pointer">Amarillo</th>
                        <th style="cursor:pointer">Magenta</th>
                        <th style="cursor:pointer">Estadística</th>
                    </tr>
                </thead>
                <tbody>
                    <% listaImpresoras.forEach(function(impresora) { %>
                        <tr>
                            <td>
                                <a href="http://<%= impresora.getIp() %>" target="_blank">
                                    <%= impresora.getIp() %>
                                </a>
                            </td>
                            <td>
                                <%= impresora.getModelo() %>
                            </td>
                            <td>
                                <%= impresora.getNumeroDeSerie() %>
                            </td>
                            <td>
                                <%= impresora.getLocalizacion() %>
                            </td>
                            <td class="text-center">
            <% if (impresora.getConectada() === "Sí") { %>
                <i class="bi bi-check-circle-fill text-success" title="Conectada"></i>
            <% } else { %>
                <i class="bi bi-x-circle-fill text-danger" title="Desconectada"></i>
            <% } %>
                            </td>
                            <td class="text-center">
                                <%= impresora.getNegro() %> %
                            </td>
                            <td class="text-center">
                                <% if (impresora.getColor() === "true") { %>
                                <%= impresora.getCyan() %> %
                                <% } %>
                            </td>
                            <td class="text-center">
                                <% if (impresora.getColor() === "true") { %>
                                <%= impresora.getAmarillo() %> %
                                <% } %>
                            </td>
                            <td class="text-center">
                                <% if (impresora.getColor() === "true") { %>
                                <%= impresora.getMagenta() %> %
                                <% } %>
                            </td>
                            <td class="text-center"> <button type="button" class="btn btn-secondary"
                                    onclick="window.open('<%=ipSeverPort%>/chart/chartIp/<%= impresora.getIp() %>/30', '_blank');">
                                    <i class="bi bi-graph-up fs-6"></i>
                                </button></td>

                        </tr>
                        <% }); %>
                </tbody>
            </table>
        </div>
    </div>
    <div class="container py-4">

        <p class="mt-2" id="contador-registros" class="text-muted small"></p>

    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const buscador = document.getElementById('buscador');
            const tbody = document.querySelector('#tabla-impresoras tbody');
            const ths = document.querySelectorAll('#tabla-impresoras th');
            const contador = document.getElementById('contador-registros');

            function actualizarContador() {
                const filas = Array.from(tbody.querySelectorAll('tr'));
                const visibles = filas.filter(f => f.style.display !== 'none').length;
                const total = filas.length;
                contador.innerText = `Mostrando ${visibles} de ${total} registros`;
            }

            function aplicarFiltro() {
                const filtro = buscador.value.trim().toLowerCase();
                const filas = Array.from(tbody.querySelectorAll('tr'));
                filas.forEach(fila => {
                    const textoFila = fila.innerText.toLowerCase();
                    fila.style.display = textoFila.includes(filtro) ? '' : 'none';
                });
                actualizarContador();
            }

            // Listener único para el input de búsqueda
            buscador.addEventListener('keyup', aplicarFiltro);
            buscador.addEventListener('search', aplicarFiltro); // por si usan botón de borrar en algunos navegadores

            // Ordenación de columnas (cada click cambia asc/desc)
            ths.forEach((th, columnIndex) => {
                th.addEventListener('click', () => {
                    const filas = Array.from(tbody.querySelectorAll('tr'));

                    const ordenActual = th.dataset.order || 'asc';
                    const nuevoOrden = ordenActual === 'asc' ? 'desc' : 'asc';
                    // opcional: limpiar orden en otros headers
                    ths.forEach(h => { if (h !== th) delete h.dataset.order; });
                    th.dataset.order = nuevoOrden;

                    filas.sort((a, b) => {
                        const celdaA = (a.children[columnIndex]?.innerText || '').trim();
                        const celdaB = (b.children[columnIndex]?.innerText || '').trim();

                        // intentar comparar IPs, números y texto
                        const numeroA = parseFloat(celdaA.replace(',', '.'));
                        const numeroB = parseFloat(celdaB.replace(',', '.'));
                        const ambosNumeros = !isNaN(numeroA) && !isNaN(numeroB);

                        if (ambosNumeros) {
                            return nuevoOrden === 'asc' ? numeroA - numeroB : numeroB - numeroA;
                        }

                        // comparar IPs numéricamente (si detecta formato x.x.x.x)
                        const ipRegex = /^\d{1,3}(\.\d{1,3}){3}$/;
                        if (ipRegex.test(celdaA) && ipRegex.test(celdaB)) {
                            const partsA = celdaA.split('.').map(n => parseInt(n, 10));
                            const partsB = celdaB.split('.').map(n => parseInt(n, 10));
                            for (let i = 0; i < 4; i++) {
                                if (partsA[i] !== partsB[i]) {
                                    return nuevoOrden === 'asc' ? partsA[i] - partsB[i] : partsB[i] - partsA[i];
                                }
                            }
                            return 0;
                        }

                        // fallback textual, idioma-agnóstico
                        return nuevoOrden === 'asc'
                            ? celdaA.localeCompare(celdaB, undefined, { numeric: true, sensitivity: 'base' })
                            : celdaB.localeCompare(celdaA, undefined, { numeric: true, sensitivity: 'base' });
                    });

                    // reinsertar filas ordenadas
                    filas.forEach(f => tbody.appendChild(f));

                    // Si hay un filtro activo, reaplicar (para mantener las filas ocultas)
                    aplicarFiltro();
                    // actualizarContador(); // aplicarFiltro ya lo llama
                });
            });

            // actualizar contador al cargar la página
            actualizarContador();
        });
    </script>


</body>

</html>